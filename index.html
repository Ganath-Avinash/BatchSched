<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Online Robust Batch Scheduling Simulator</title>
  <meta name="description" content="Interactive simulator for online robust batch job scheduling with deadline constraints, load smoothing, and worst-case robustness analysis." />
  <meta name="keywords" content="scheduling, batch processing, EDF, algorithms, DAA, load balancing" />
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="src/pngegg.png">
</head>
<body>

<!-- ================================================
     APP SHELL
     ================================================ -->
<!-- app-shell hidden until Firebase confirms auth (prevents flash of content) -->
<div class="app-shell" id="appShell" style="display:none">

  <!-- HEADER -->
  <header>
    <div class="header-inner">
      <div class="logo">
        <div class="logo-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/>
          </svg>
        </div>
        <div>
          <div class="logo-text"><span>Batch</span>Sched</div>
        </div>
      </div>
      <h1 style="font-size:clamp(0.8rem,2vw,1rem); color:var(--text-secondary); font-weight:500; display:none;" id="headerTitle">
        Online Robust Batch Scheduling Simulator
      </h1>
      <div class="header-actions">
        <div class="day-badge" id="currentDayBadge">â–¸ Day 1</div>
        <span id="userGreeting" style="font-size:0.78rem; color:var(--text-muted); font-weight:500;"></span>
        <button id="darkModeToggle" title="Toggle light/dark mode" aria-label="Toggle dark mode">ğŸŒ™</button>
        <button id="logoutBtn" onclick="handleLogout()" title="Logout"
          style="background:transparent; border:1px solid rgba(239,68,68,0.35); color:#fca5a5;
                 border-radius:var(--radius-sm); padding:0.35rem 0.75rem; font-size:0.78rem;
                 font-weight:600; cursor:pointer; transition:all 0.2s;">
          Sign Out
        </button>
      </div>
    </div>
  </header>

  <!-- MAIN CONTENT -->
  <main id="mainGrid">

    <!-- â”€â”€â”€ CONTROLS CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <section class="card" id="controlsCard" aria-label="Job Controls">
      <div class="card-title">Control Panel</div>

      <!-- Sub-section: Add Job -->
      <div style="margin-bottom:1.25rem;">
        <div style="font-size:0.75rem; font-weight:700; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.06em; margin-bottom:0.75rem;">
          Add New Job
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label for="jobCompute">Compute Units (C<sub>i</sub>)</label>
            <input type="number" id="jobCompute" min="1" max="100" value="8" placeholder="e.g. 8" />
          </div>
          <div class="form-group">
            <label for="jobDeadline">Deadline â€” Day (D<sub>i</sub>)</label>
            <input type="number" id="jobDeadline" min="1" value="3" placeholder="e.g. 3" />
          </div>
          <div class="form-group full">
            <button class="btn-primary" id="addJobBtn" onclick="handleAddJob()">
              Add Job to Pool
            </button>
          </div>
        </div>
      </div>

      <hr style="border:none;border-top:1px solid var(--border-gentle);margin:0.75rem 0;" />

      <!-- Sub-section: Scheduler Config -->
      <div style="margin-bottom:1.25rem;">
        <div style="font-size:0.75rem; font-weight:700; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.06em; margin-bottom:0.75rem;">
          Scheduler Config
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label for="batchSizeN">Batch Size (N)</label>
            <input type="number" id="batchSizeN" min="1" max="50" value="5" />
          </div>
          <div class="form-group">
            <label for="strategySelect">Strategy</label>
            <select id="strategySelect">
              <option value="edf">EDF + Smoothing</option>
              <option value="lcf">Largest Compute First</option>
              <option value="random">Random Selection</option>
            </select>
          </div>
        </div>

        <!-- Day control -->
        <div class="day-control" style="margin-top:0.85rem;">
          <span>Current Day</span>
          <div style="display:flex; align-items:center; gap:0.6rem;">
            <button class="btn-ghost" style="padding:0.3rem 0.65rem; font-size:0.85rem;" onclick="changeDay(-1)">â—€</button>
            <strong id="dayDisplay">1</strong>
            <button class="btn-ghost" style="padding:0.3rem 0.65rem; font-size:0.85rem;" onclick="changeDay(1)">â–¶</button>
          </div>
        </div>
      </div>

      <hr style="border:none;border-top:1px solid var(--border-gentle);margin:0.75rem 0;" />

      <!-- Sub-section: Actions -->
      <div class="btn-group">
        <button class="btn-primary" id="runBtn" onclick="handleRunScheduler()">
          â–¶ Run Today's Scheduler
        </button>

        <div class="btn-row">
          <button class="btn-secondary" onclick="handleSimulateMultipleDays()">
            Simulate 7 Days
          </button>
          <button class="btn-crimson" onclick="handleInjectWorstCase()">
            Inject Worst Case
          </button>
        </div>

        <div class="btn-row">
          <button class="btn-ocean" onclick="handleCompareStrategies()">
            Compare Strategies
          </button>
          <button class="btn-secondary" onclick="handleStepMode()">
            Step-by-Step
          </button>
        </div>

        <div class="btn-row">
          <button class="btn-ghost" onclick="handleAddRandomJobs()">
            Add 5 Random Jobs
          </button>
          <button class="btn-ghost" onclick="showResetConfirm()" id="resetBtn">
            Reset All
          </button>
        </div>

        <!-- Inline reset confirmation banner (hidden by default) -->
        <div id="resetConfirmBanner" style="display:none; margin-top:0.65rem; background:rgba(239,68,68,0.1); border:1px solid rgba(239,68,68,0.35); border-radius:var(--radius-sm); padding:0.75rem 1rem;">
          <p style="font-size:0.82rem; color:#fca5a5; margin-bottom:0.6rem;">This will clear all jobs, charts, and history. Continue?</p>
          <div style="display:flex; gap:0.5rem;">
            <button class="btn-danger" style="flex:1; padding:0.45rem;" onclick="handleReset()">Yes, Reset</button>
            <button class="btn-ghost"  style="flex:1; padding:0.45rem;" onclick="hideResetConfirm()">Cancel</button>
          </div>
        </div>
      </div>

      <!-- Progress bar for multi-day sim -->
      <div class="sim-progress" id="simProgress">
        <div class="sim-progress-bar" id="simProgressBar"></div>
      </div>
    </section>

    <!-- â”€â”€â”€ METRICS CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <section class="card" id="metricsCard" aria-label="Metrics">
      <div class="card-title">
        <span class="icon">ğŸ“Š</span> Live Metrics
        <div style="margin-left:auto; font-size:0.7rem; color:var(--text-muted);" id="lastRunLabel">No run yet</div>
      </div>

      <div class="metrics-grid">
        <div class="metric-tile tile-primary">
          <span class="metric-icon">âš¡</span>
          <div class="metric-value" id="m-compute">â€”</div>
          <div class="metric-label">Compute Today</div>
        </div>
        <div class="metric-tile tile-secondary">
          <span class="metric-icon">ğŸ“¦</span>
          <div class="metric-value" id="m-selected">â€”</div>
          <div class="metric-label">Jobs Selected</div>
        </div>
        <div class="metric-tile tile-danger">
          <span class="metric-icon">â³</span>
          <div class="metric-value" id="m-expired">â€”</div>
          <div class="metric-label">Expired Today</div>
        </div>
        <div class="metric-tile tile-warn">
          <span class="metric-icon">ğŸ—‚ï¸</span>
          <div class="metric-value" id="m-backlog">â€”</div>
          <div class="metric-label">Backlog</div>
        </div>
        <div class="metric-tile tile-accent">
          <span class="metric-icon" style="font-family:'JetBrains Mono',monospace; font-size:1.6rem; font-weight:700; color:var(--accent);">ÏƒÂ²</span>
          <div class="metric-value" id="m-variance">â€”</div>
          <div class="metric-label">Load Variance</div>
        </div>
        <div class="metric-tile tile-primary" style="--tile-accent:#38f9d7;">
          <span class="metric-icon">ğŸ“ˆ</span>
          <div class="metric-value" id="m-avgLoad">â€”</div>
          <div class="metric-label">Avg Load/Day</div>
        </div>
      </div>

      <!-- Strategy summary pill -->
      <div style="margin-top:1rem; display:flex; align-items:center; gap:0.6rem; flex-wrap:wrap;">
        <span style="font-size:0.75rem; color:var(--text-muted);">Active strategy:</span>
        <span class="pill pill-safe" id="strategySummaryPill">EDF + Smoothing</span>
        <span style="font-size:0.75rem; color:var(--text-muted); margin-left:auto;" id="poolSizeLabel">Pool: 0 jobs</span>
      </div>
    </section>

    <!-- â”€â”€â”€ TABLES SECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <section id="tablesSection" aria-label="Job Tables">
      <div class="tables-grid">

        <!-- Pending Jobs -->
        <div class="table-card">
          <div class="table-header">
            <div class="table-title" style="color:var(--warn);">
              ğŸŸ¡ Pending Jobs
            </div>
            <span class="table-badge" id="pendingBadge">0</span>
          </div>
          <div class="table-wrapper">
            <table id="pendingTable" aria-label="Pending jobs">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Compute</th>
                  <th>Deadline</th>
                  <th>Urgency</th>
                </tr>
              </thead>
              <tbody id="pendingBody">
                <tr><td colspan="4"><div class="empty-state"><span class="empty-icon">ğŸ“­</span>No pending jobs</div></td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Selected Jobs -->
        <div class="table-card">
          <div class="table-header">
            <div class="table-title" style="color:var(--accent);">
              âœ… Selected (Running)
            </div>
            <span class="table-badge" id="selectedBadge">0</span>
          </div>
          <div class="table-wrapper">
            <table id="selectedTable" aria-label="Selected jobs">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Compute</th>
                  <th>Deadline</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="selectedBody">
                <tr><td colspan="4"><div class="empty-state"><span class="empty-icon">â³</span>Run the scheduler</div></td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Expired Jobs -->
        <div class="table-card">
          <div class="table-header">
            <div class="table-title" style="color:var(--danger);">
              âŒ Expired (Missed)
            </div>
            <span class="table-badge" id="expiredBadge">0</span>
          </div>
          <div class="table-wrapper">
            <table id="expiredTable" aria-label="Expired jobs">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Compute</th>
                  <th>Deadline</th>
                  <th>Added Day</th>
                </tr>
              </thead>
              <tbody id="expiredBody">
                <tr><td colspan="4"><div class="empty-state"><span class="empty-icon">âœ”ï¸</span>None expired yet</div></td></tr>
              </tbody>
            </table>
          </div>
        </div>

      </div>
    </section>

    <!-- â”€â”€â”€ CHARTS SECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <section id="chartsSection" aria-label="Charts">
      <div class="charts-grid">
        <div class="chart-card">
          <div class="chart-title">âš¡ Daily Compute Load</div>
          <div class="chart-wrapper"><canvas id="computeChart"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="chart-title">ğŸ—‚ï¸ Backlog Size Over Time</div>
          <div class="chart-wrapper"><canvas id="backlogChart"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="chart-title">ğŸ“‰ Load Variance Over Time</div>
          <div class="chart-wrapper"><canvas id="varianceChart"></canvas></div>
        </div>
        <div class="chart-card" id="placeholderChartCard">
          <div class="chart-title">ğŸ“‹ Run Summary</div>
          <div id="runSummaryPanel" style="padding:0.5rem 0;">
            <div class="empty-state" style="padding:3rem 1rem;">
              <span class="empty-icon">ğŸš€</span>
              Press <strong>"Run Today's Scheduler"</strong> or <strong>"Simulate 7 Days"</strong> to see results here.
            </div>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- FOOTER -->
  <footer>
    <p>Online Robust Batch Scheduling Simulator &nbsp;Â·&nbsp; DAA Project &nbsp;Â·&nbsp;
      2026 Â© All Rights Reserved</p>
  </footer>

</div><!-- /app-shell -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     STEP-BY-STEP MODAL
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="stepModal" role="dialog" aria-modal="true" aria-label="Step-by-step walkthrough">
  <div class="modal-box">
    <div class="modal-header">
      <h2 style="font-size:1.1rem;">ğŸ” Step-by-Step Scheduling</h2>
      <button class="modal-close" onclick="closeStepModal()" aria-label="Close">âœ•</button>
    </div>
    <ul class="step-list" id="stepList"></ul>
    <div style="margin-top:1.25rem; display:flex; gap:0.65rem; justify-content:flex-end;">
      <button class="btn-ghost" onclick="closeStepModal()">Close</button>
      <button class="btn-primary" onclick="handleRunScheduler(); closeStepModal();">â–¶ Run Now</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     STRATEGY COMPARISON OVERLAY
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="comparisonOverlay" role="dialog" aria-modal="true" aria-label="Strategy comparison chart">
  <div class="comparison-box">
    <div class="modal-header">
      <h2 style="font-size:1.1rem;">ğŸ“Š Strategy Comparison â€” 7 Day Simulation</h2>
      <button class="modal-close" onclick="closeComparisonOverlay()" aria-label="Close">âœ•</button>
    </div>
    <p style="font-size:0.82rem; margin-bottom:0.5rem;">Comparing daily compute load across EDF+Smoothing, Largest Compute First, and Random Selection over 7 simulated days with the same random seed conditions.</p>
    <div class="comparison-chart-wrapper">
      <canvas id="comparisonChart"></canvas>
    </div>
    <div style="margin-top:1rem; display:flex; gap:0.65rem; justify-content:flex-end;">
      <button class="btn-ghost" onclick="closeComparisonOverlay()">Close</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TOAST CONTAINER
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="toastContainer" aria-live="polite" aria-label="Notifications"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCRIPTS  (order matters)
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FIREBASE AUTH GUARD
     Must run before app scripts so the shell stays hidden
     until we confirm the user is signed in.
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script type="module">
import { auth } from './firebase-config.js';
import {
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";

onAuthStateChanged(auth, (user) => {
  if (!user) {
    // Not signed in â†’ go to login page
    window.location.replace('login.html');
  } else {
    // Signed in â†’ reveal the app and show user info
    document.getElementById('appShell').style.display = '';
    const greeting = document.getElementById('userGreeting');
    if (greeting) {
      // Show display name if set, else show email
      greeting.textContent = `Hi, ${user.displayName || user.email}`;
    }
  }
});

// Expose logout to the Sign Out button (onclick="handleLogout()")
window.handleLogout = async () => {
  await signOut(auth);
  // onAuthStateChanged fires with user=null â†’ auto-redirects to login.html
};
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<script src="scheduler.js"></script>
<script src="simulation.js"></script>
<script src="charts.js"></script>

<script>
/* ================================================================
   app.js  (inline)
   Main UI controller â€” connects DOM events to engine + charts.
   ================================================================ */
'use strict';

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   STATE
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let today          = 1;
let computeHistory = [];   // Used locally for variance tracking
let allExpired     = [];   // Cumulative expired list across runs

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   INIT
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.addEventListener('DOMContentLoaded', () => {
  initialiseAllCharts();
  loadFromLocalStorage();
  updateDayDisplay();
  renderPendingTable(getJobPool());
  updatePoolSizeLabel();

  // Seed a handful of demo jobs so the UI is non-empty on load
  if (getJobPool().length === 0) {
    seedDemoJobs();
  }
});

function seedDemoJobs() {
  const demos = [
    { c: 5, d: 1 }, { c: 12, d: 2 }, { c: 3, d: 3 },
    { c: 9, d: 2 }, { c: 7, d: 4 }, { c: 15, d: 3 },
  ];
  demos.forEach(({ c, d }) => {
    try { addJob(c, Math.max(d, today), today); } catch (_) {}
  });
  renderPendingTable(getJobPool());
  updatePoolSizeLabel();
  showToast('Demo jobs loaded. Press â–¶ Run to begin!', 'info');
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   DAY MANAGEMENT
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function changeDay(delta) {
  const next = today + delta;
  if (next < 1) return;
  today = next;
  updateDayDisplay();
  updateJobDeadlineMin();
}

function updateDayDisplay() {
  document.getElementById('dayDisplay').textContent = today;
  document.getElementById('currentDayBadge').textContent = `â–¸ Day ${today}`;
  document.getElementById('jobDeadline').min = today;
}

function updateJobDeadlineMin() {
  const dl = document.getElementById('jobDeadline');
  if (+dl.value < today) dl.value = today;
  dl.min = today;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ADD JOB
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function handleAddJob() {
  const compute  = parseInt(document.getElementById('jobCompute').value, 10);
  const deadline = parseInt(document.getElementById('jobDeadline').value, 10);

  if (isNaN(compute) || compute < 1) { showToast('Compute must be â‰¥ 1', 'error'); return; }
  if (isNaN(deadline) || deadline < today) { showToast(`Deadline must be â‰¥ today (Day ${today})`, 'error'); return; }

  const job = addJob(compute, deadline, today);
  renderPendingTable(getJobPool());
  updatePoolSizeLabel();
  saveToLocalStorage();
  showToast(`Job #${job.id} added â€” C:${compute} D:${deadline}`, 'success');
  animateAddJobBtn();
}

function animateAddJobBtn() {
  const btn = document.getElementById('addJobBtn');
  btn.style.transform = 'scale(0.96)';
  setTimeout(() => btn.style.transform = '', 150);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ADD RANDOM JOBS
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function handleAddRandomJobs() {
  generateRandomJobs(5, today);
  renderPendingTable(getJobPool());
  updatePoolSizeLabel();
  saveToLocalStorage();
  showToast('5 random jobs added', 'success');
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   RUN SCHEDULER (single day)
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function handleRunScheduler() {
  const N        = getN();
  const strategy = getStrategy();

  if (getJobPool().length === 0) {
    showToast('Job pool is empty â€” add some jobs first!', 'warn');
    return;
  }

  setRunning(true);

  // Small timeout so UI can repaint the loading state
  setTimeout(() => {
    const result = runScheduler(today, N, strategy, computeHistory);

    // Update history
    computeHistory.push(result.totalCompute);
    allExpired.push(...result.expired);

    // Charts
    pushDayToCharts(result, computeHistory);

    // Advance day FIRST so all table labels use the new current day
    today++;
    updateDayDisplay();
    updateJobDeadlineMin();

    // Sweep: jobs not selected whose deadline is now past â†’ auto-expire them
    // (runScheduler pruned deadline < old_today; now catch deadline < new_today)
    const { expired: nowExpired } = removeExpiredJobs(today);
    if (nowExpired.length > 0) {
      allExpired.push(...nowExpired);
    }

    // Tables â€” render pending from fresh pool (after sweep above)
    renderPendingTable(getJobPool());
    renderSelectedTable(result.selected);
    renderExpiredTable(allExpired);

    // Metrics & summary
    updateMetrics(result);
    renderRunSummary(result);

    saveToLocalStorage();
    setRunning(false);
    showToast(`Day ${result.day} complete â€” ${result.selected.length} jobs scheduled`, 'success');
  }, 50);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   SIMULATE MULTIPLE DAYS
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function handleSimulateMultipleDays() {
  const N        = getN();
  const strategy = getStrategy();
  const days     = 7;

  setRunning(true);
  resetAllCharts();
  computeHistory = [];
  allExpired     = [];

  const progress   = document.getElementById('simProgress');
  const progressBar = document.getElementById('simProgressBar');
  progress.classList.add('active');
  progressBar.style.width = '0%';

  const results = simulateMultipleDays(days, N, strategy);

  // Animate chart updates sequentially
  let i = 0;
  const step = () => {
    if (i >= results.length) {
      // All done
      const last = results[results.length - 1];
      renderPendingTable(last.remaining);
      renderSelectedTable(last.selected);
      renderExpiredTable(allExpired);
      updateMetricsFromHistory(results);
      today = days + 1;
      updateDayDisplay();
      updateJobDeadlineMin();
      saveToLocalStorage();
      setRunning(false);
      progress.classList.remove('active');
      showToast(`${days}-day simulation complete!`, 'success');
      renderMultiDaySummary(results);
      return;
    }
    const r = results[i];
    computeHistory.push(r.totalCompute);
    allExpired.push(...(r.expired || []));
    pushDayToCharts(r, computeHistory);
    progressBar.style.width = `${((i + 1) / results.length) * 100}%`;
    i++;
    setTimeout(step, 180);  // Stagger updates for animation effect
  };
  step();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   INJECT WORST CASE
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function handleInjectWorstCase() {
  const injected = injectWorstCaseTomorrow(today);
  renderPendingTable(getJobPool());
  updatePoolSizeLabel();
  showToast(`âš ï¸ Worst-case injected: ${injected.length} heavy/urgent jobs added!`, 'warn');
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   STRATEGY COMPARISON
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function handleCompareStrategies() {
  const N    = getN();
  const days = 7;

  showToast('Running strategy comparisonâ€¦', 'info');

  setTimeout(() => {
    const data = compareStrategies(days, N, 5);
    renderComparisonChart('comparisonChart', data);
    document.getElementById('comparisonOverlay').classList.add('open');
  }, 80);
}

function closeComparisonOverlay() {
  document.getElementById('comparisonOverlay').classList.remove('open');
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   STEP-BY-STEP MODE
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function handleStepMode() {
  const N        = getN();
  const strategy = getStrategy();
  const pool     = getJobPool();

  const steps = buildStepList(pool, N, strategy, today);
  const list  = document.getElementById('stepList');
  list.innerHTML = '';

  steps.forEach((s, idx) => {
    const li = document.createElement('li');
    li.className = 'step-item';
    li.style.animationDelay = `${idx * 80}ms`;
    li.innerHTML = `
      <div class="step-num">${idx + 1}</div>
      <div class="step-content">
        <strong>${s.title}</strong>
        <p>${s.detail}</p>
      </div>`;
    list.appendChild(li);
  });

  document.getElementById('stepModal').classList.add('open');
}

function closeStepModal() {
  document.getElementById('stepModal').classList.remove('open');
}

/**
 * buildStepList â€“ produce human-readable scheduling steps.
 */
function buildStepList(pool, N, strategy, day) {
  const expired = pool.filter(j => j.deadline < day);
  const active  = pool.filter(j => j.deadline >= day);
  const sorted  = sortJobs(active, strategy);
  const selected = sorted.slice(0, N);

  const strategyNames = { edf: 'EDF + Load Smoothing', lcf: 'Largest Compute First', random: 'Random Selection' };

  return [
    {
      title: 'Snapshot Job Pool',
      detail: `${pool.length} jobs in pool. ${expired.length} have passed their deadline.`,
    },
    {
      title: 'Remove Expired Jobs',
      detail: expired.length
        ? `Removed ${expired.length} expired job(s): IDs ${expired.map(j=>j.id).join(', ')}.`
        : 'No jobs expired. Proceeding with full pool.',
    },
    {
      title: `Sort by Strategy: ${strategyNames[strategy]}`,
      detail: strategy === 'edf'
        ? 'Jobs sorted by deadline (asc). Ties broken by compute (asc) for load smoothing.'
        : strategy === 'lcf'
        ? 'Jobs sorted by compute units (desc). Ties broken by deadline (asc).'
        : 'Jobs randomly shuffled using Fisher-Yates algorithm.',
    },
    {
      title: `Select Top-${N} Jobs`,
      detail: selected.length
        ? `Selected ${selected.length} job(s): IDs ${selected.map(j=>j.id).join(', ')}. Total compute: ${selected.reduce((a,b)=>a+b.compute,0)} units.`
        : 'No jobs could be selected (pool was empty after pruning).',
    },
    {
      title: 'Compute Metrics',
      detail: `Backlog remains at ${active.length - selected.length} job(s). Compute history is updated for variance tracking.`,
    },
    {
      title: 'Robustness Check',
      detail: selected.every(j => j.deadline >= day)
        ? 'âœ… All selected jobs meet their deadlines. Schedule is feasible.'
        : 'âš ï¸ Some selected jobs are at deadline today â€” highest urgency protected.',
    },
  ];
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   RESET
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function showResetConfirm() {
  document.getElementById('resetConfirmBanner').style.display = 'block';
  document.getElementById('resetBtn').disabled = true;
}

function hideResetConfirm() {
  document.getElementById('resetConfirmBanner').style.display = 'none';
  document.getElementById('resetBtn').disabled = false;
}

function handleReset() {
  hideResetConfirm();

  // 1. Clear engine state
  resetSimulation();

  // 2. Clear UI state
  computeHistory = [];
  allExpired     = [];
  today          = 1;

  // 3. Reset display
  updateDayDisplay();
  updateJobDeadlineMin();
  resetAllCharts();
  clearTables();
  resetMetrics();
  clearLocalStorage();

  // 4. Reset the run summary panel
  document.getElementById('runSummaryPanel').innerHTML = `
    <div class="empty-state" style="padding:3rem 1rem;">
      <span class="empty-icon" style="font-size:2rem;">â†º</span>
      Reset complete. Add jobs and press run!
    </div>`;

  // 5. Re-seed demo jobs so the app isn't a blank slate
  seedDemoJobs();

  updatePoolSizeLabel();
  showToast('Simulator reset to initial state.', 'info');
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   TABLE RENDERERS
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderPendingTable(jobs) {
  const body  = document.getElementById('pendingBody');
  const badge = document.getElementById('pendingBadge');
  badge.textContent = jobs.length;

  if (jobs.length === 0) {
    body.innerHTML = `<tr><td colspan="4"><div class="empty-state"><span class="empty-icon">ğŸ“­</span>No pending jobs</div></td></tr>`;
    return;
  }

  body.innerHTML = jobs.map(j => {
    const { rowClass, pill } = urgencyClass(j, today);
    return `
      <tr class="${rowClass}">
        <td><code>#${j.id}</code></td>
        <td><strong style="color:var(--primary-light)">${j.compute}</strong></td>
        <td>Day ${j.deadline}</td>
        <td>${pill}</td>
      </tr>`;
  }).join('');
  updatePoolSizeLabel();
}

function renderSelectedTable(jobs) {
  const body  = document.getElementById('selectedBody');
  const badge = document.getElementById('selectedBadge');
  badge.textContent = jobs.length;

  if (jobs.length === 0) {
    body.innerHTML = `<tr><td colspan="4"><div class="empty-state"><span class="empty-icon">â³</span>Run the scheduler</div></td></tr>`;
    return;
  }

  body.innerHTML = jobs.map((j, i) => {
    const { rowClass } = urgencyClass(j, today - 1); // use previous today
    return `
      <tr class="${rowClass} row-highlight" style="animation-delay:${i * 80}ms">
        <td><code>#${j.id}</code></td>
        <td><strong style="color:var(--accent)">${j.compute}</strong></td>
        <td>Day ${j.deadline}</td>
        <td><span class="pill pill-safe">âœ” Scheduled</span></td>
      </tr>`;
  }).join('');
}

function renderExpiredTable(jobs) {
  const body  = document.getElementById('expiredBody');
  const badge = document.getElementById('expiredBadge');

  // De-duplicate by id
  const unique = [...new Map(jobs.map(j => [j.id, j])).values()];
  badge.textContent = unique.length;

  if (unique.length === 0) {
    body.innerHTML = `<tr><td colspan="4"><div class="empty-state"><span class="empty-icon">âœ”ï¸</span>None expired yet</div></td></tr>`;
    return;
  }

  body.innerHTML = unique.map(j => `
    <tr>
      <td><code>#${j.id}</code></td>
      <td>${j.compute}</td>
      <td>Day ${j.deadline}</td>
      <td>Day ${j.addedDay}</td>
    </tr>`).join('');
}

function clearTables() {
  renderPendingTable([]);
  renderSelectedTable([]);
  renderExpiredTable([]);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   URGENCY HELPER
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function urgencyClass(job, day) {
  if (job.deadline <= day) {
    return {
      rowClass: 'row-urgent',
      pill: '<span class="pill pill-urgent">ğŸ”´ Due Today</span>',
    };
  } else if (job.deadline === day + 1) {
    return {
      rowClass: 'row-soon',
      pill: '<span class="pill pill-soon">ğŸŸ  Tomorrow</span>',
    };
  }
  return {
    rowClass: 'row-safe',
    pill: '<span class="pill pill-safe">ğŸŸ¢ Safe</span>',
  };
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   METRICS UPDATE
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function updateMetrics(result) {
  setValue('m-compute',  result.totalCompute);
  setValue('m-selected', result.selected.length);
  setValue('m-expired',  allExpired.length);
  setValue('m-backlog',  result.backlogSize);
  setValue('m-variance', result.variance.toFixed(1));
  const avg = computeHistory.length
    ? (computeHistory.reduce((a,b)=>a+b,0) / computeHistory.length).toFixed(1)
    : 'â€”';
  setValue('m-avgLoad', avg);
  document.getElementById('lastRunLabel').textContent = `Last run: Day ${result.day}`;
  updateStrategyPill();
  updatePoolSizeLabel();
}

function updateMetricsFromHistory(results) {
  const last = results[results.length - 1];
  updateMetrics({ ...last, backlogSize: last.remaining.length });
}

function resetMetrics() {
  ['m-compute','m-selected','m-expired','m-backlog','m-variance','m-avgLoad'].forEach(id => setValue(id, 'â€”'));
  document.getElementById('lastRunLabel').textContent = 'No run yet';
}

function setValue(id, val) {
  const el = document.getElementById(id);
  if (!el) return;
  el.textContent = val;
  el.style.animation = 'none';
  void el.offsetWidth;
  el.style.animation = 'step-appear 0.4s ease';
}

function updateStrategyPill() {
  const strategyNames = { edf: 'EDF + Smoothing', lcf: 'Largest Compute First', random: 'Random Selection' };
  const s = getStrategy();
  const pill = document.getElementById('strategySummaryPill');
  pill.textContent = strategyNames[s] || s;
  pill.className = 'pill ' + (s === 'edf' ? 'pill-safe' : s === 'lcf' ? 'pill-soon' : 'pill-urgent');
}

function updatePoolSizeLabel() {
  document.getElementById('poolSizeLabel').textContent = `Pool: ${getJobPool().length} jobs`;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   RUN SUMMARY PANEL
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderRunSummary(result) {
  const panel = document.getElementById('runSummaryPanel');
  const efficiencyPct = result.selected.length
    ? Math.round((result.selected.length / (result.selected.length + result.backlogSize)) * 100)
    : 0;

  panel.innerHTML = `
    <div style="display:flex; flex-direction:column; gap:0.65rem; padding:0.25rem 0;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <span style="font-size:0.8rem; color:var(--text-muted);">Day ${result.day} â€” ${result.strategy.toUpperCase()}</span>
        <span class="pill pill-safe">âœ” Complete</span>
      </div>
      ${summaryRow('Jobs Scheduled',    result.selected.length,   'var(--accent)')}
      ${summaryRow('Compute Dispatched', result.totalCompute,     'var(--primary-light)')}
      ${summaryRow('Total Expired',       allExpired.length,       'var(--secondary)')}
      ${summaryRow('Remaining Backlog',  result.backlogSize,      'var(--warn)')}
      ${summaryRow('Load Variance',      result.variance.toFixed(2), 'var(--text-secondary)')}
      <div style="margin-top:0.5rem;">
        <div style="font-size:0.72rem; color:var(--text-muted); margin-bottom:0.3rem;">Schedule Efficiency</div>
        <div style="background:var(--bg-input); border-radius:99px; height:8px; overflow:hidden;">
          <div style="background:var(--grad-success); height:100%; width:${efficiencyPct}%; border-radius:99px; transition:width 0.8s ease;"></div>
        </div>
        <div style="font-size:0.72rem; color:var(--accent); margin-top:0.25rem; text-align:right;">${efficiencyPct}%</div>
      </div>
    </div>`;
}

function renderMultiDaySummary(results) {
  const panel = document.getElementById('runSummaryPanel');
  const totalSelected = results.reduce((a,r) => a + r.selected.length, 0);
  const totalExpired  = results.reduce((a,r) => a + (r.expired||[]).length, 0);
  const totalCompute  = results.reduce((a,r) => a + r.totalCompute, 0);
  const avgCompute    = (totalCompute / results.length).toFixed(1);

  panel.innerHTML = `
    <div style="display:flex; flex-direction:column; gap:0.65rem; padding:0.25rem 0;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <span style="font-size:0.8rem; color:var(--text-muted);">${results.length}-Day Summary</span>
        <span class="pill pill-safe">âœ” Complete</span>
      </div>
      ${summaryRow('Total Scheduled', totalSelected, 'var(--accent)')}
      ${summaryRow('Total Compute',   totalCompute,  'var(--primary-light)')}
      ${summaryRow('Total Expired',   totalExpired,  'var(--secondary)')}
      ${summaryRow('Avg Compute/Day', avgCompute,    'var(--warn)')}
      ${summaryRow('Final Backlog',   results[results.length-1].remaining.length, 'var(--text-secondary)')}
    </div>`;
}

function summaryRow(label, value, color) {
  return `
    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border-gentle); padding:0.35rem 0;">
      <span style="font-size:0.8rem; color:var(--text-muted);">${label}</span>
      <strong style="color:${color}; font-size:0.9rem;">${value}</strong>
    </div>`;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   HELPERS
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function getN() {
  return Math.max(1, parseInt(document.getElementById('batchSizeN').value, 10) || 5);
}
function getStrategy() {
  return document.getElementById('strategySelect').value || 'edf';
}
function setRunning(isRunning) {
  document.getElementById('runBtn').disabled = isRunning;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   DARK MODE TOGGLE
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const toggleBtn = document.getElementById('darkModeToggle');
let isDark = true;

toggleBtn.addEventListener('click', () => {
  isDark = !isDark;
  document.body.classList.toggle('light-mode', !isDark);
  toggleBtn.textContent = isDark ? 'ğŸŒ™' : 'â˜€ï¸';
  localStorage.setItem('theme', isDark ? 'dark' : 'light');
});

// Dark mode is always the default
localStorage.removeItem('theme');

// Restore theme preference
(function() {
  const saved = localStorage.getItem('theme');
  if (saved === 'light') {
    isDark = false;
    document.body.classList.add('light-mode');
    toggleBtn.textContent = 'â˜€ï¸';
  }
})();
// Note: handleLogout and auth guard are in the Firebase module script above

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   TOAST NOTIFICATIONS
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function showToast(message, type = 'info') {
  const icons = { success: 'âœ…', error: 'âŒ', warn: 'âš ï¸', info: 'â„¹ï¸' };
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.innerHTML = `<span>${icons[type] || 'â„¹ï¸'}</span> ${message}`;
  container.appendChild(toast);

  setTimeout(() => {
    toast.classList.add('leaving');
    toast.addEventListener('animationend', () => toast.remove());
  }, 3500);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   LOCAL STORAGE PERSISTENCE
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function saveToLocalStorage() {
  try {
    localStorage.setItem('batchsched_pool', JSON.stringify(getJobPool()));
    localStorage.setItem('batchsched_day',  today);
    localStorage.setItem('batchsched_history', JSON.stringify(computeHistory));
  } catch (_) {}
}

function loadFromLocalStorage() {
  try {
    const pool    = JSON.parse(localStorage.getItem('batchsched_pool') || 'null');
    const day     = parseInt(localStorage.getItem('batchsched_day'), 10);
    const history = JSON.parse(localStorage.getItem('batchsched_history') || 'null');

    if (pool && Array.isArray(pool)) {
      pool.forEach(j => addJob(j.compute, j.deadline, j.addedDay || 1));
    }
    if (!isNaN(day) && day >= 1) today = day;
    if (history && Array.isArray(history)) computeHistory = history;
  } catch (_) {}
}

function clearLocalStorage() {
  localStorage.removeItem('batchsched_pool');
  localStorage.removeItem('batchsched_day');
  localStorage.removeItem('batchsched_history');
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   KEYBOARD SHORTCUTS
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    closeStepModal();
    closeComparisonOverlay();
  }
  // Ctrl+Enter â†’ run scheduler
  if (e.ctrlKey && e.key === 'Enter') {
    handleRunScheduler();
    e.preventDefault();
  }
});

// Close modals when clicking backdrop
document.getElementById('stepModal').addEventListener('click', e => {
  if (e.target === document.getElementById('stepModal')) closeStepModal();
});
document.getElementById('comparisonOverlay').addEventListener('click', e => {
  if (e.target === document.getElementById('comparisonOverlay')) closeComparisonOverlay();
});


</script>

</body>
</html>
